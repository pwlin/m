<?php
namespace{
$config = [
    //'cache_type' => 'file',
    //'cache_type' => 'none',
    //'cache_path' => '../cache',
    //'cache_ttl' => 1440,
    //'db_bookmarks_table_name' => 'bookmarks',
    //'db_api_keys_table_name' => 'api_keys',
    //'db_type' => 'mysql',
    //'db_type' => 'sqlite',
    //'db_file' => '../db/salad.sqlite',
    //'db_host' => '127.0.0.1',
    //'db_port' => '3306',
    //'db_name' => 'salad',
    //'db_username' => 'root',
    //'db_password' => '',
    //'enable_cors_headers' => false,
    //'enable_web_api' => false,
    //'fetch_favicons' => false,
    //'fetch_popular_tags' => false,
    //'minify_html_output' => false,
    //'insert_example_bookmarks' => true,
    //'auth_api_keys_enabled' => false,
    //'api_keys' => [
    //    [
    //        'key1' => 'dev-api-key',
    //        'access_level' => 1,
    //        'enabled' => false
    //    ]
    //],
    //'auth_digest_enabled' => false,
    //'auth_digest_users' => [
    //    [
    //        'username' => 'admin',
    //        'password' => 'admin',
    //        'access_level' => 9,
    //        'enabled' => false
    //    ],
    //],
    //'route_not_found' => [
    //    'func' => '\Salad\API\Controllers\NotFound::index',
    //    'format' => !empty($_GET['format']) ? $_GET['format'] : 'html',
    //    'args' => [
    //        'access_level_needed' => 0
    //    ]
    //],
    //'routes' => [
    //    [
    //        'uri' => '/',
    //        'func' => '\Salad\API\Controllers\Home::index',
    //        'format' => !empty($_GET['format']) ? $_GET['format'] : 'html',
    //        'args' => [
    //            'access_level_needed' => 0
    //        ]
    //    ]
    //]
];
/*The MIT License (MIT)

Copyright (c) 2022 pwlin/Salad contributors - pwlin05@gmail.com

https://github.com/pwlin/salad-api/

Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
the Software, and to permit persons to whom the Software is furnished to do so,
subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*/
}
namespace Salad{
class Auth{private $salad;public function __construct($salad){$this->salad=$salad;}private function loginWithAPIKey($selectedApiKey,$accessLevelNeeded){$configApiKeys=$this->salad->config->get('api_keys');if(!empty($configApiKeys)){$apiKeys=['result'=>$configApiKeys];}else{$apiKeys=$this->salad->db->select('SELECT * FROM '.$this->salad->config->get('db_api_keys_table_name'));}$ret=false;foreach($apiKeys['result'] as $v){if( $v['key1']===$selectedApiKey && intval($v['access_level']) >= $accessLevelNeeded && in_array($v['enabled'],['yes','true',true]) ){$ret=true;if(!empty($v['tags_whitelist'])){$this->salad->request->setParam('tags_whitelist',$v['tags_whitelist']);}break;}} return $ret;}private function loginWithHttpDigest($accessLevelNeeded){$realm='Salad Restricted Area';if(empty($_SERVER['PHP_AUTH_DIGEST'])){$this->showLoginDialog($realm);return false;}else{$data=$this->httpDigestParse($_SERVER['PHP_AUTH_DIGEST']);$digestUsers=$this->salad->config->get('auth_digest_users',[]);$selectedUser=[];foreach($digestUsers as $u){if( $u['username']===@$data['username'] && $u['access_level'] >= $accessLevelNeeded && in_array($u['enabled'],['yes','true',true]) ){$selectedUser=$u;break;}} if(empty($selectedUser)){return false;}$A1=md5($data['username'].':'.$realm.':'.$selectedUser['password']);$A2=md5($_SERVER['REQUEST_METHOD'].':'.$data['uri']);$validResponse=md5($A1.':'.$data['nonce'].':'.$data['nc'].':'.$data['cnonce'].':'.$data['qop'].':'.$A2);if($data['response']!==$validResponse){return false;}else{return true;}}}public function login($args=[]){$args['access_level_needed']=intval($args['access_level_needed']);if($args['access_level_needed']!==0 && !isset($args['access_level_needed'])){$args['access_level_needed']=9;}if( $this->salad->request->getParam('is_cli')===true || $args['access_level_needed']===0 || @$args['skip_auth']===true ){return true;}$selectedApiKey=$this->apiKeyFromHeader();if(empty($selectedApiKey)){$selectedApiKey=@$args['api_key'];}if(!empty($selectedApiKey) && $this->salad->config->get('auth_api_keys_enabled')===true){return $this->loginWithAPIKey($selectedApiKey,$args['access_level_needed']);}elseif($this->salad->config->get('auth_digest_enabled')===true){return $this->loginWithHttpDigest($args['access_level_needed']);}else{return false;}} private function apiKeyFromHeader(){$apiKey='';$headers=getallheaders();if(isset($headers['Authorization'])){$authHeader=$headers['Authorization'];if(preg_match('/Bearer\s(\S+)/',$authHeader,$matches)){$apiKey=$matches[1];}} elseif(isset($headers['X-Api-Key'])){$apiKey=$headers['X-Api-Key'];}else if(isset($headers['X-Auth-Token'])){$apiKey=$headers['X-Auth-Token'];}return $apiKey;}private function showLoginDialog($realm){header('HTTP/1.1 401 Unauthorized');header('WWW-Authenticate:Digest realm="'.$realm.'",qop="auth",nonce="'.uniqid().'",opaque="'.md5($realm).'"');}private function httpDigestParse($txt){$needed_parts=array('nonce'=>1,'nc'=>1,'cnonce'=>1,'qop'=>1,'username'=>1,'uri'=>1,'response'=>1);$data=array();$keys=implode('|',array_keys($needed_parts));preg_match_all('@('.$keys.')=(?:([\'"])([^\2]+?)\2|([^\s,]+))@',$txt,$matches,PREG_SET_ORDER);foreach($matches as $m){$data[$m[1]]=$m[3]?$m[3]:$m[4];unset($needed_parts[$m[1]]);}return $needed_parts?false:$data;}}
class Cache{private $salad;public function __construct($salad){$this->salad=$salad;}public function makeCacheKey($key=[],$prefix=''){return $prefix.md5($prefix.serialize($key));}public function get($key,$default=false){if($this->salad->config->get('cache_type')==='none'){return false;}$cacheFile=$this->salad->config->get('cache_path').'/'.$key;if(is_file($cacheFile)){$data=json_decode(file_get_contents($cacheFile),true);if($data['expires']>0 && $data['expires']<time()){@unlink($cacheFile);}else{$default=$data['value'];}} return $default;}public function set($key,$value,$ttl=false){if($this->salad->config->get('cache_type')==='none'){return;}if($ttl<0){$ttl=0;}else{if($ttl===false){$ttl=intval($this->salad->config->get('cache_ttl',1440)) * 60;}$ttl=time() + $ttl;}$data=array( 'expires'=>$ttl,'value'=>$value );$path=$this->salad->config->get('cache_path').'/';if(!is_dir($path.dirname($key))){$this->mkdirRecursive($path.dirname($key));}@file_put_contents($path.$key,json_encode($data));@chmod($path.$key,0666);}private function mkdirRecursive($pathname,$mode=0777){if(!is_dir(dirname($pathname))){return $this->mkdirRecursive(dirname($pathname),$mode);}if(!is_dir($pathname)){mkdir($pathname);@chmod($pathname,$mode);}return is_dir($pathname);}public function cleanFolder($folderName){if($this->salad->config->get('cache_type')==='none'){return;}foreach(glob($this->salad->config->get('cache_path').'/'.$folderName.'/'.'*') as $filename){@unlink($filename);}@rmdir($this->salad->config->get('cache_path').'/'.$folderName);}}
class Config{private array $params=[];private function setDefaultParams(){$this->params=['cache_type'=>'none','cache_path'=>'../cache','cache_ttl'=>1440,'db_bookmarks_table_name'=>'bookmarks','db_api_keys_table_name'=>'api_keys','db_type'=>'mysql','db_file'=>'../db/salad.sqlite','db_host'=>'127.0.0.1','db_port'=>'3306','db_name'=>'salad','db_username'=>'root','db_password'=>'','enable_cors_headers'=>false,'enable_web_api'=>false,'fetch_favicons'=>false,'fetch_popular_tags'=>false,'minify_html_output'=>false,'insert_example_bookmarks'=>true,'auth_api_keys_enabled'=>false,'api_keys'=>[['key1'=>'dev-api-key','access_level'=>1,'enabled'=>false]],'auth_digest_enabled'=>false,'auth_digest_users'=>[['username'=>'admin','password'=>'admin','access_level'=>9,'enabled'=>false],],'route_not_found'=>['func'=>'\Salad\API\Controllers\NotFound::index','format'=>!empty($_GET['format'])?$_GET['format']:'html','args'=>['access_level_needed'=>0]],'routes'=>[['uri'=>'/','func'=>'\Salad\API\Controllers\Home::index','format'=>!empty($_GET['format'])?$_GET['format']:'html','args'=>['access_level_needed'=>0]],['uri'=>'/tags','func'=>'\Salad\API\Controllers\Home::index','format'=>!empty($_GET['format'])?$_GET['format']:'html','args'=>['access_level_needed'=>9]],['uri'=>'/posts','func'=>'\Salad\API\Controllers\Home::index','format'=>!empty($_GET['format'])?$_GET['format']:'html','args'=>['access_level_needed'=>9]],['uri'=>'/tags/get','func'=>'\Salad\API\Controllers\Tags\Get::index','format'=>@$_GET['format'],'args'=>['tag'=>@$_GET['tag'],'search'=>@$_GET['search'],'sort'=>@$_GET['sort'],'api_key'=>@$_GET['api_key'],'access_level_needed'=>9]],['uri'=>'/tags/recent','func'=>'\Salad\API\Controllers\Tags\Recent::index','format'=>@$_GET['format'],'args'=>['api_key'=>@$_GET['api_key'],'access_level_needed'=>9]],['uri'=>'/tags/rename','func'=>'\Salad\API\Controllers\Tags\Rename::index','format'=>@$_GET['format'],'args'=>['old'=>@$_GET['old'],'new'=>@$_GET['new'],'api_key'=>@$_GET['api_key'],'access_level_needed'=>9]],['uri'=>'/tags/delete','func'=>'\Salad\API\Controllers\Tags\Delete::index','format'=>@$_GET['format'],'args'=>['tag'=>@$_GET['tag'],'also_delete_bookmarks'=>@$_GET['also_delete_bookmarks'],'api_key'=>@$_GET['api_key'],'access_level_needed'=>9]],['uri'=>'/posts/update','func'=>'\Salad\API\Controllers\Posts\Update::index','format'=>@$_GET['format'],'args'=>['api_key'=>@$_GET['api_key'],'access_level_needed'=>9]],['uri'=>'/posts/add','func'=>'\Salad\API\Controllers\Posts\Add::index','format'=>@$_GET['format'],'args'=>['url'=>@$_GET['url'],'description'=>@$_GET['description'],'extended'=>@$_GET['extended'],'tags'=>@$_GET['tags'],'dt'=>@$_GET['dt'],'replace'=>@$_GET['replace'],'shared'=>@$_GET['shared'],'old_hash'=>@$_GET['old_hash'],'shared'=>@$_GET['shared'],'api_key'=>@$_GET['api_key'],'access_level_needed'=>9]],['uri'=>'/posts/delete','func'=>'\Salad\API\Controllers\Posts\Delete::index','format'=>@$_GET['format'],'args'=>['url'=>@$_GET['url'],'api_key'=>@$_GET['api_key'],'access_level_needed'=>9]],['uri'=>'/posts/get','func'=>'\Salad\API\Controllers\Posts\Get::index','format'=>@$_GET['format'],'args'=>['tag'=>@$_GET['tag'],'search'=>@$_GET['search'],'dt'=>@$_GET['dt'],'url'=>@$_GET['url'],'hashes'=>@$_GET['hashes'],'api_key'=>@$_GET['api_key'],'access_level_needed'=>9]],['uri'=>'/posts/recent','func'=>'\Salad\API\Controllers\Posts\Recent::index','format'=>@$_GET['format'],'args'=>['tag'=>@$_GET['tag'],'count'=>@$_GET['count'],'api_key'=>@$_GET['api_key'],'access_level_needed'=>9]],['uri'=>'/posts/dates','func'=>'\Salad\API\Controllers\Posts\Dates::index','format'=>@$_GET['format'],'args'=>['tag'=>@$_GET['tag'],'api_key'=>@$_GET['api_key'],'access_level_needed'=>9]],['uri'=>'/posts/all?hashes','func'=>'\Salad\API\Controllers\Posts\AllHashes::index','format'=>@$_GET['format'],'args'=>['api_key'=>@$_GET['api_key'],'access_level_needed'=>9]],['uri'=>'/posts/all','func'=>'\Salad\API\Controllers\Posts\All::index','format'=>@$_GET['format'],'args'=>['tag'=>@$_GET['tag'],'search'=>@$_GET['search'],'start'=>@$_GET['start'],'results'=>@$_GET['results'],'count'=>@$_GET['count'],'count_only'=>@$_GET['count_only'],'api_key'=>@$_GET['api_key'],'access_level_needed'=>9]],['uri'=>'/posts/suggest','func'=>'\Salad\API\Controllers\Posts\Suggest::index','format'=>@$_GET['format'],'args'=>['url'=>@$_GET['url'],'api_key'=>@$_GET['api_key'],'access_level_needed'=>9]],['uri'=>'/posts/favicon','func'=>'\Salad\API\Controllers\Posts\FavIcon::index','format'=>'png','args'=>['hash'=>@$_GET['hash'],'url'=>@$_GET['url'],'api_key'=>@$_GET['api_key'],'access_level_needed'=>9]],['uri'=>'/keys/gen','func'=>'\Salad\API\Controllers\Keys\Gen::index','format'=>@$_GET['format'],'args'=>['api_key'=>@$_GET['api_key'],'access_level_needed'=>9]],['uri'=>'/keys/all','func'=>'\Salad\API\Controllers\Keys\All::index','format'=>@$_GET['format'],'args'=>['api_key'=>@$_GET['api_key'],'access_level_needed'=>9]],['uri'=>'/keys/add','func'=>'\Salad\API\Controllers\Keys\Add::index','format'=>@$_GET['format'],'args'=>['api_key'=>@$_GET['api_key'],'key1'=>@$_GET['key1'],'description'=>@$_GET['description'],'access_level'=>@$_GET['access_level'],'enabled'=>@$_GET['enabled'],'tags_whitelist'=>@$_GET['tags_whitelist'],'access_level_needed'=>9]],['uri'=>'/keys/update','func'=>'\Salad\API\Controllers\Keys\Update::index','format'=>@$_GET['format'],'args'=>['api_key'=>@$_GET['api_key'],'id'=>@$_GET['id'],'key1'=>@$_GET['key1'],'description'=>@$_GET['description'],'access_level'=>@$_GET['access_level'],'enabled'=>@$_GET['enabled'],'tags_whitelist'=>@$_GET['tags_whitelist'],'access_level_needed'=>9]],['uri'=>'/keys/delete','func'=>'\Salad\API\Controllers\Keys\Delete::index','format'=>@$_GET['format'],'args'=>['api_key'=>@$_GET['api_key'],'id'=>@$_GET['id'],'access_level_needed'=>9]]]];}public function __construct($salad){$this->setDefaultParams();if(is_file('./config.php')){$config=include('./config.php');if(is_array($config)){$this->params=array_merge($this->params,$config);}} if(is_file('./config.user.php')){$userConfig=include('./config.user.php');if(is_array($userConfig)){$this->params=array_merge($this->params,$userConfig);}}}public function get($key,$default=false){return isset($this->params[$key])?$this->params[$key]:$default;}public function getAll(){return $this->params;}public function set($key,$val=''){$configItems=[];if(!is_array($key)){$configItems[$key]=$val;}else{$configItems=$key;}foreach($configItems as $k=>$v){$this->params[$k]=$v;}} }
class DB{private $dbh;private $salad;public function __construct($salad){$this->salad=$salad;}public function query($sql){return $this->dbh->query($sql);}public function init(){try{switch($this->salad->config->get('db_type')){case 'sqlite';default:$this->dbh=new \PDO('sqlite:'.$this->salad->config->get('db_file'));$this->exec('PRAGMA encoding="UTF-8"');break;case 'mysql':$this->dbh=new \PDO('mysql:host='.$this->salad->config->get('db_host').';port='.$this->salad->config->get('db_port').';charset=utf8mb4;dbname='.$this->salad->config->get('db_name'),$this->salad->config->get('db_username'),$this->salad->config->get('db_password'),[]);break;}$this->dbh->setAttribute(\PDO::ATTR_ERRMODE,\PDO::ERRMODE_EXCEPTION);if(!$this->tableExists($this->salad->config->get('db_bookmarks_table_name'))){$this->createInitialDB();if($this->salad->config->get('insert_example_bookmarks')===true){$this->insertExampleBookmarks();$this->insertExampleAPIKeys();}}}catch (\PDOException $e){exit('DB Error:'.$e->getMessage());}} public function exec($query,$params=[]){if($this->dbh===null){$this->init();}$queries=[];if(is_array($query)){$queries=$query;}else{$queries[]=['sql'=>$query,'params'=>$params];}$this->dbh->beginTransaction();try{foreach($queries as $q){$qParams=[];if(is_array($q)){$qParams=!empty($q['params'])?$q['params']:[];$qSQL=$q['sql'];}else{$qSQL=$q;}$stmt=$this->dbh->prepare($qSQL);$stmt->execute($qParams);}$result=$this->dbh->commit();return ['msg'=>'ok','result'=>$result];}catch (\PDOException $e){$this->dbh->rollBack();return ['msg'=>$e->getMessage(),'result'=>0,'sql'=>$query,'params'=>$params];}} public function select($query,$params=[]){if($this->dbh===null){$this->init();}try{$sth=$this->dbh->prepare($query);$sth->setFetchMode(\PDO::FETCH_ASSOC);$sth->execute($params);$result=$sth->fetchAll();return ['msg'=>'ok','result'=>$result];}catch (\PDOException $e){return ['msg'=>$e->getMessage(),'result'=>[],'sql'=>$query,'params'=>$params];}} private function createInitialDB(){switch($this->salad->config->get('db_type')){case 'mysql':$schema=explode(';','CREATE TABLE `bookmarks` ( `id` INT(11) NOT NULL AUTO_INCREMENT PRIMARY KEY, `url` TEXT NOT NULL, `description` TEXT NOT NULL, `extended` TEXT DEFAULT "", `tags` TEXT DEFAULT "", `created` VARCHAR(15) NOT NULL, `modified` VARCHAR(15) NOT NULL, `hash` VARCHAR(32) NOT NULL, `shared` VARCHAR(3) NOT NULL DEFAULT "yes", INDEX (`created`), INDEX (`modified`), INDEX (`shared`), UNIQUE (`hash`)) ENGINE=InnoDB DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;CREATE TABLE `api_keys` ( `id` INT(11) NOT NULL AUTO_INCREMENT PRIMARY KEY, `key1` VARCHAR(255) NOT NULL, `description` VARCHAR(255) DEFAULT "", `access_level` VARCHAR(2) NOT NULL DEFAULT "1", `enabled` VARCHAR(3) NOT NULL DEFAULT "no", `tags_whitelist` TEXT DEFAULT "", INDEX (`enabled`), UNIQUE (`key1`)) ENGINE=InnoDB DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;');break;case 'sqlite':default:$schema=explode(';','CREATE TABLE "bookmarks" ("id" INTEGER PRIMARY KEY AUTOINCREMENT,"url" TEXT NOT NULL,"description" TEXT NOT NULL,"extended" TEXT DEFAULT "","tags" TEXT DEFAULT "","created" TEXT NOT NULL,"modified" TEXT NOT NULL,"hash" TEXT NOT NULL,"shared" TEXT NOT NULL DEFAULT "yes");CREATE INDEX "created" ON "bookmarks" ("created");CREATE INDEX "modified" ON "bookmarks" ("modified");CREATE INDEX "shared" ON "bookmarks" ("shared");CREATE UNIQUE INDEX "hash" ON "bookmarks" ("hash");CREATE TABLE "api_keys" ("id" INTEGER PRIMARY KEY AUTOINCREMENT,"key1" TEXT NOT NULL,"description" TEXT DEFAULT "","access_level" TEXT NOT NULL DEFAULT "1","enabled" TEXT NOT NULL DEFAULT "no","tags_whitelist" TEXT DEFAULT "");CREATE INDEX "enabled" ON "api_keys" ("enabled");CREATE UNIQUE INDEX "key1" ON "api_keys" ("key1");');break;}$schema=array_filter($schema,'trim');$schema=array_filter($schema,'strlen');$schema=array_map(function ($value){return str_replace( ['CREATE TABLE `bookmarks`','CREATE TABLE "bookmarks"','CREATE TABLE `api_keys`','CREATE TABLE "api_keys"'],['CREATE TABLE `'.$this->salad->config->get('db_bookmarks_table_name').'`','CREATE TABLE "'.$this->salad->config->get('db_bookmarks_table_name').'"','CREATE TABLE `'.$this->salad->config->get('db_api_keys_table_name').'`','CREATE TABLE "'.$this->salad->config->get('db_api_keys_table_name').'"'],$value );},$schema);foreach($schema as $query){$this->dbh->exec($query);}} private function tableExists($table){try{$this->dbh->query('SELECT 1 FROM '.$table);}catch (\PDOException $e){return false;}return true;}private function insertExampleBookmarks(){$bookmarks=json_decode('[ { "url": "https://github.com/notwaldorf/dear-sir-or-madam", "description": "notwaldorf/dear-sir-or-madam: 💌 Bookmarklet that ransomifies your internets", "tags": "javascript bookmarklet github color" }, { "url": "http://www.srehttp.org/apps/gif_text/mkgiftxt.htm", "description": "GIF_TEXT: A Graphics Text Generator", "tags": "image generator gif" }, { "url": "https://browsers.evolt.org/", "description": "evolt.org - Browser Archive", "tags": "browsers archive javascript" }, { "url": "https://www.mercurytheatre.info/", "description": "The Mercury Theatre on the Air", "tags": "audio media radio" }, { "url": "color:FFFFFF,81C757,333333,D3D2D2,0000FF,DDDDDD,FF0000", "description": "Salad color scheme", "tags": "color swatches" }, { "url": "https://web.archive.org/web/20050207095344/http://home.earthlink.net/~sarasohn/aboutgs.html", "description": "Father Guido Sarducci", "tags": "media comedy tv" }]',true);$queries=[];$url='';$tags='';foreach($bookmarks as $link){if(!empty($link['post'])){$link=$link['post'];}if(!empty($link['url'])){$url=$link['url'];}elseif(!empty($link['href'])){$url=$link['href'];}if(!empty($link['tag'])){$tags=$link['tag'];}elseif(!empty($link['tags'])){$tags=$link['tags'];}if(!empty($link['time'])){$dt=strtotime($link['time']);}else{$dt=strtotime('now');}$url2=$url;$queries[]=['sql'=>'INSERT INTO '.$this->salad->config->get('db_bookmarks_table_name').' (url,description,extended,tags,created,modified,hash,shared) VALUES (:url,:description,:extended,:tags,:created,:modified,:hash,:shared)','params'=>['url'=>$url2,'description'=>@$link['description'],'extended'=>@$link['extended'],'tags'=>' '.$tags.' ','created'=>$dt,'modified'=>$dt,'hash'=>md5($url),'shared'=>'yes']];}$this->exec($queries);}private function insertExampleAPIKeys(){$queries=[];$queries[]=['sql'=>'INSERT INTO '.$this->salad->config->get('db_api_keys_table_name').' (key1,description,access_level,enabled) VALUES (:key1,:description,:access_level,:enabled)','params'=>['key1'=>'1234','description'=>'key1','access_level'=>'1','enabled'=>'no']];$this->exec($queries);}}
class Main{public $config;public $auth;public $db;public $cache;public $request;public $response;public $utils;public $sqlUtils;public $view;public $models;public $ext;public function __construct($api_file_included=false){$this->utils=new \Salad\Utils($this);$this->config=new \Salad\Config($this);$this->auth=new \Salad\Auth($this);$this->db=new \Salad\DB($this);$this->cache=new \Salad\Cache($this);$this->request=new \Salad\Request($this);$this->response=new \Salad\Response($this);$this->sqlUtils=new \Salad\SQLUtils($this);$this->view=new \Salad\View($this);if($api_file_included===true){$this->request->setParam('file_api_included',true);}} public function registerMyObjects($objects=[]){if(!empty($objects['models'])){$this->models=new \stdClass();foreach($objects['models']['classes'] as $modelClass){$class=$objects['models']['namespace'].'\\'.ucfirst($modelClass);$this->models->$modelClass=new $class($this);}} if(!empty($objects['ext'])){$this->ext=new \stdClass();foreach($objects['ext']['classes'] as $extClass){$class=$objects['ext']['namespace'].'\\'.ucfirst($extClass);$this->ext->$extClass=new $class($this);}}}}
class Request{protected $salad;public function __construct($salad){$this->salad=$salad;$this->setParams();}private array $params=['uri'=>'/','base_uri'=>'/','format'=>'json','is_cli'=>false,'file_api_included'=>false,'callback'=>'','context'=>''];protected function setParams(){switch(PHP_SAPI){case 'cli':$this->setParam('is_cli',true);$this->setCliParams();break;default:self::setWebParams();break;}$this->setParam('callback',$this->salad->utils->safeForJSONP(''.@$_GET['callback']));$this->setParam('context',$this->salad->utils->safeForJSONP(''.@$_GET['context']));}private function setCliParams(){global $argv;if(count($argv)<2){die("Usage:php <file.php><uri> [key=value]...\n");}$url=$argv[1];$this->setParam('uri',$url);for ($i=2;$i<count($argv);$i++){$parts=explode('=',$argv[$i],2);if(count($parts) == 2){$_GET[$parts[0]]=$parts[1];}else{die("Invalid argument format:{$argv[$i]}. Expected format:key=value\n");}} $this->setParam('base_uri','/');}private function setWebParams(){$uri=rtrim(filter_var(@$_SERVER['REQUEST_URI'],FILTER_SANITIZE_URL),'/').'/';$pattern='/^\/[^\/]*\.php/';$uri=preg_replace($pattern,'',$uri);if(strpos($uri,'all?hashes')===false){$uri=preg_replace('/\?(.*)$/','',$uri);}$uri=rtrim($uri,'/');if(empty($uri)){$uri='/';}$this->setUri($uri,preg_replace("/\/[^\/]+$/",'/',@$_SERVER['SCRIPT_NAME']));}private function setFileIncludedParams($options){preg_match('/(.*)\?(.*)/',$options['uri'],$urlMatches);$this->setUri($urlMatches[1],@$options['base_uri']);parse_str($urlMatches[2],$urlMatches);$_GET=array_merge($_GET,$urlMatches);if(!empty($_GET['format'])){$this->setParam('format',$_GET['format']);}} public function setParam($key,$val){$this->params[$key]=$val;}public function getParam($key,$default=''){return !empty($this->params[$key])?$this->params[$key]:$default;}public function setUri($uri='',$baseUri=''){if(!empty($uri)){$this->setParam('uri',$uri);if(!empty($baseUri)){$this->setParam('base_uri',$baseUri);}}}public function handle($options=[]){if(!empty($options['uri']) && $this->salad->request->getParam('file_api_included')===true){$this->setFileIncludedParams($options);}$router=new \Salad\Router($this->salad);$selectedRoute=$router->findRoute();$this->salad->response->setOutputData(call_user_func($selectedRoute[0],$selectedRoute[1],$selectedRoute[2]));}private string $fullBaseUri='';public function getFullBaseUri(){if(!empty($this->fullBaseUri)){return $this->fullBaseUri;}$fullBaseUri='';$port='';if(!empty($_SERVER['HTTP_HOST'])){switch($_SERVER['SERVER_PORT']){case '80':case '443':break;default:$port=':'.$_SERVER['SERVER_PORT'];break;}$fullBaseUri .= $_SERVER['REQUEST_SCHEME'].'://'.$_SERVER['HTTP_HOST'].$port;}$fullBaseUri .= $this->getParam('base_uri');$this->fullBaseUri=$fullBaseUri;return $this->fullBaseUri;}}
class Response{private array $outputData=[];private $salad;public function __construct($salad){$this->salad=$salad;}public function setOutputData($outputData){$outputData=$outputData===null?[]:$outputData;$this->outputData=$outputData;}public function getOutput($setHeaders=false){if($setHeaders===true){$this->setHeaders($this->salad->request->getParam('format'));}return $this->generateOutput($this->salad->request->getParam('format'));}public function setHeaders($format){if($this->salad->request->getParam('is_cli')===true || $this->salad->request->getParam('api_self_included')===true){return;}$this->setCorsHeaders();$this->setExtraHeaders();$this->setContentTypeHeader($format);}private function setContentTypeHeader($format){$contentType='';switch($format){case 'xml':$contentType='text/xml;charset=utf-8';break;case 'json':case 'js':$contentType='text/javascript;charset=utf-8';break;case 'css':$contentType='text/css;charset=utf-8';break;case 'webmanifest':$contentType='application/manifest+json;charset=utf-8';break;case 'html':case 'html-partial':$contentType='text/html;charset=utf-8';break;case 'png':$contentType='image/png';break;case 'svg':$contentType='image/svg+xml';break;case 'text':case 'txt':default:$contentType='text/plain;charset=utf-8';break;}header('Content-type:'.$contentType);}private function setCorsHeaders(){if($this->salad->config->get('enable_cors_headers')===true){header('Access-Control-Allow-Origin:*',true);header('Access-Control-Allow-Methods:GET,PUT,POST,DELETE,OPTIONS',true);header('Access-Control-Allow-Headers:Origin,Content-Type,X-Auth-Token,Authorization,X-Api-Key',true);}} private function setExtraHeaders(){header('Referrer-Policy:no-referrer',true);header('X-Content-Type-Options:nosniff',true);}private function generateOutput($format){$data='';switch($format){case 'xml':default:$data=$this->generateXML();break;case 'json':$data=$this->generateJSON();$cb=$this->salad->request->getParam('callback');$cnx=$this->salad->request->getParam('context');if(!empty($cb)){$data=$cb.'('.$data;if(!empty($cnx)){$data .= ',"'.$cnx.'"';}$data .= ');';}break;case 'html':$data=$this->generateHTML(true);break;case 'html-partial':$data=$this->generateHTML(false);break;case 'css':case 'js':case 'webmanifest':case 'png':case 'svg':case 'text':case 'txt':$data=$this->generateText();break;}return $data;}private function generateXML(){if(empty($this->outputData['xml'])){$xml='<result code="no data for this format" />';}else{$xml=$this->outputData['xml'];}$xml=new \SimpleXMLElement($xml);return $xml->asXML();}private function generateHTML($fullHTML=false){if($fullHTML===false){$partialHTML=@$this->outputData['html']['body'];if($this->salad->config->get('minify_html_output')===true){$partialHTML=$this->salad->utils->minifyOutput(['body'=>$partialHTML])['body'];}return $partialHTML;}else{$htmlSkeleton='<!DOCTYPE html><html lang="en" class="notranslate" translate="no"><head><meta http-equiv="Content-Security-Policy" content="default-src \'self\';img-src \'self\' data:;object-src \'self\';script-src \'nonce-'.$this->nonce().'\' \'strict-dynamic\';style-src \'nonce-'.$this->nonce().'\';base-uri \'none\';form-action \'self\';manifest-src \'self\';" /><meta name="description" content="'.$this->salad->config->get('site_description','Salad').'" /><meta name="viewport" content="width=device-width,initial-scale=0.99,minimum-scale=0.99" /><title>'.trim(''.@$this->outputData['html']['title']).'</title><meta name="theme-color" content="#000000" /><meta name="referrer" content="no-referrer" /><meta name="robots" content="noindex,nofollow,nosnippet,noarchive,noodp,notranslate,noimageindex,nositelinkssearchbox" />';if($this->salad->config->get('minify_html_output')===true){$htmlSkeleton=$this->salad->utils->minifyOutput(['body'=>$htmlSkeleton])['body'];}if(!empty($this->outputData['html']['head'])){if($this->salad->config->get('minify_html_output')===true){$this->outputData['html']['head']=$this->salad->utils->minifyOutput(['head'=>$this->outputData['html']['head']])['head'];}$htmlSkeleton .= $this->outputData['html']['head'];}if(!empty($this->outputData['html']['css'])){$htmlSkeleton .= '<style nonce="'.$this->nonce().'">';if($this->salad->config->get('minify_html_output')===true){$this->outputData['html']['css']=$this->salad->utils->minifyOutput(['css'=>$this->outputData['html']['css']])['css'];}$htmlSkeleton .= $this->outputData['html']['css'];$htmlSkeleton .= '</style>';}$htmlSkeleton .= '</head><body>';if(!empty($this->outputData['html']['body'])){if($this->salad->config->get('minify_html_output')===true){$this->outputData['html']['body']=$this->salad->utils->minifyOutput(['body'=>$this->outputData['html']['body']])['body'];}$htmlSkeleton .= $this->outputData['html']['body'];}if(!empty($this->outputData['html']['js'])){$htmlSkeleton .= '<script nonce="'.$this->nonce().'">';if($this->salad->config->get('minify_html_output')===true){$this->outputData['html']['js']=$this->salad->utils->minifyOutput(['js'=>$this->outputData['html']['js']])['js'];}$htmlSkeleton .= $this->outputData['html']['js'];$htmlSkeleton .= '</script>';}$htmlSkeleton .= '</body></html>';return $htmlSkeleton;}} private function generateText(){if(!empty($this->outputData['bin-data'])){return $this->outputData['bin-data'];}$text=$this->outputData['text'];if($this->salad->config->get('minify_html_output')===true){$text=$this->salad->utils->minifyOutput(['body'=>$text])['body'];}return $text;}private function generateJSON(){return isset($this->outputData['array'])?json_encode($this->outputData['array']):$this->xmlToJson(@$this->outputData['xml']);}private string $nonce='';public function nonce(){if(!empty($this->nonce)){return $this->nonce;}$this->nonce=bin2hex(random_bytes(10));return $this->nonce;}public function debug($obj,$type="pr"){switch($type){case 'pr':default:header('content-type:text/plain;');print_r($obj);break;case 'vd':header('content-type:text/html;');var_dump($obj);break;}die();}public function debugF($context,$data){if(!is_array($data)){$data=[$data];}$data=json_encode($data,JSON_PRETTY_PRINT);$txt="\n".date('g:i:s A',strtotime('now')).":".$data."\n";file_put_contents($this->salad->config->get('cache_path').'/'.$context.'.txt',$txt,FILE_APPEND | LOCK_EX);}public function generateErrorMessage($type,$message=''){$message=!empty($message)?$message:'something went wrong';return $this->generateGenericMessage($type,$message);}public function generateDoneMessage($type,$message=''){$message=!empty($message)?$message:'done';return $this->generateGenericMessage($type,$message,true);}public function generateAuthFailedMessage(){return $this->generateErrorMessage('for:posts','Authentication Failed');}public function generateNotFoundMessage(){return $this->generateErrorMessage('for:posts','404 Not Found');}private function generateGenericMessage($type='for:tags',$message='',$isPositive=false){switch($type){case 'for:posts':$xml='<result code="'.$message.'" />';$array=['result'=>['code'=>$message]];break;case 'for:tags':default:$xml='<result>'.$message.'</result>';$array=['result'=>$message];break;}if($isPositive===true){$html=['title'=>$message,'body'=>$message,];}else{$sadKitty='data:image/jpeg;base64,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';$html=['title'=>$message,'body'=>'<figure><img alt="'.$message.'" src="'.$sadKitty.'" /><figcaption>'.$message.'</figcaption></figure>','css'=>'body {background-color:#000000;} figure {margin:0;padding:0;text-align:left;} figcaption{ text-align:center;width:191px;color:aqua;}'];}return ['xml'=>$xml,'array'=>$array,'html'=>$html];}private function xmlToJson($xmlContent){if(!$xmlContent){$xml=['result'=>['code'=>'no data for this format']];}else{$xml=new \SimpleXMLElement($xmlContent);}return json_encode($xml);}public function redirect($url){header('Location:'.$url);exit(0);}}
class Router{private $salad;public function __construct($salad){$this->salad=$salad;}private function setRouteAliases(){$routeAliases=[];foreach($this->salad->config->get('routes') as $cr){if(!empty($cr['aliases'])){$cr['aliases']=is_array($cr['aliases'])?$cr['aliases']:[$cr['aliases']];foreach($cr['aliases'] as $alias){$routeAliases[]=['uri'=>$alias,'func'=>$cr['func'],'format'=>@$cr['format'],'args'=>@$cr['args']];}}}$this->salad->config->set('routes',array_merge($routeAliases,$this->salad->config->get('routes')));}public function findRoute(){$requestedUri=$this->salad->request->getParam('uri');$baseUri=rtrim($this->salad->request->getParam('base_uri'),'/');if(empty($baseUri)){$baseUri='/';}if($this->salad->request->getParam('base_uri')!=='/'){$requestedUri=str_replace($baseUri,'',$requestedUri);}$requestedUri='/'.trim($requestedUri,'/');$this->setRouteAliases();$currentRoute=[];foreach($this->salad->config->get('routes') as $route){$pattern=$route['uri'];$args=[];if(preg_match("#^$pattern$#",$requestedUri,$matches)){array_shift($matches);$route['args']=!empty($route['args'])?$route['args']:[];$route['args']=array_filter($route['args'],fn ($value)=>$value!==null && $value!=='' && $value!=='undefined');foreach($route['args'] as $key=>$value){if(preg_match('/\$\d/',$value)){$index=intval(str_replace('$','',$value)) - 1;if(preg_match('/\$\d/',$key)){$k=intval(str_replace('$','',$key)) - 1;$args[$matches[$k]]=$this->salad->utils->urldecode($matches[$index]);}else{$args[$key]=$this->salad->utils->urldecode($matches[$index]);}} else{$args[$key]=$this->salad->utils->urldecode($value);}} foreach($_GET as $key=>$value){if(!isset($args[$key]) && !in_array($key,['access_level','access_level_needed','skip_auth','skip_url_check'])){$args[$key]=$this->salad->utils->urldecode($value);}} $currentRoute=[$route['func'],$this->salad,$args];$this->setRouteFormat(@$route['format']);break;}} if(empty($currentRoute)){$r=$this->salad->config->get('route_not_found');$this->setRouteFormat(@$r['format']);$currentRoute=[$r['func'],$this->salad,@$r['args']];}return $currentRoute;}private function setRouteFormat($format=''){if($this->salad->request->getParam('is_cli')===true){if(!empty($_GET['format'])){$this->salad->request->setParam('format',$_GET['format']);}} else{if(!empty($format)){$this->salad->request->setParam('format',$format);}}}}
class SQLUtils{private $salad;public function __construct($salad){$this->salad=$salad;}public function buildWhereQueryForTags($tags=''){$where='';$data=[];$selected_tags=[];$tagsWhitelist=$this->salad->request->getParam('tags_whitelist');if(!empty($tags) || !empty($tagsWhitelist)){if(!empty($tagsWhitelist)){$tags .= ' '.$tagsWhitelist;}$tags=str_replace(',',' ',$tags);$tags=str_replace('+',' ',$tags);$tags_arr=array_unique(explode(' ',$tags));$i=0;foreach($tags_arr as $tag){$tag=trim($tag);if(!empty($tag)){$i++;$where .= ' tags LIKE :tag'.$i.' AND ';$data['tag'.$i]='% '.$tag.' %';$selected_tags[]=$tag;}} unset($i,$tag);}$where=rtrim($where,' AND ');return [$where,$data,$selected_tags];}public function buildWhereQueryForSearch($search=''){$where='';$data=[];if(!empty($search)){$search_arr=array_unique(explode(' ',$search));$where .= ' ( ';$search_columns=['url','description','extended'];$i=0;foreach($search_columns as $s_column){$where .= '( ';foreach($search_arr as $s){$i++;$where .= ' '.$s_column.' LIKE :'.$s_column.$i.' AND ';$data[$s_column.$i]='%'.$s.'%';}$where=rtrim($where,' AND ');$where .= ' ) OR ';}$where=rtrim($where,' OR ');$where .= ' ) ';}return [$where,$data];}public function buildWhereQueryForUrl($url){$where='';$data=[];if(!empty($url)){$where .= ' url=:url ';$data['url']=$url;}return [$where,$data];}public function buildWhereQueryForHashes($hashes=''){$where='';$data=[];if(!empty($hashes)){$hashes_arr=array_unique(explode(' ',$hashes));$i=0;foreach($hashes_arr as $hash){$hash=trim($hash);if(!empty($hash)){$i++;$where .= ' hash=:hashes'.$i.' OR ';$data['hashes'.$i]=$hash;}} unset($i,$hash);}$where=rtrim($where,' OR ');return [$where,$data];}public function buildWhereQueryForDate($dt=''){$where='';$data=[];if(!empty($dt)){$dtStart=strtotime(gmdate('d.m.Y 00:00:00',strtotime($dt)));$dtEnd=strtotime(gmdate('d.m.Y 23:59:59',strtotime($dt)));$where .= ' created BETWEEN "'.$dtStart.'" AND "'.$dtEnd.'" ';}return [$where,$data];}}
class Utils{private $salad;public function __construct($salad){$this->salad=$salad;}public function isValidUrl($url){if(!$url){return false;}$path=parse_url($url,PHP_URL_PATH);$encoded_path=array_map('urlencode',explode('/',$path));$url=str_replace($path,implode('/',$encoded_path),$url);return filter_var($url,FILTER_VALIDATE_URL)?true:false;}private function removeJsComments($jsString=''){$jsString=preg_replace('~(?<!http:|https:)//[^\n]*~','',$jsString);$jsString=preg_replace('~/\*.*?\*/~s','',$jsString);$jsString=preg_replace('~\s*([{}():;,<>%=&|!])\s*~','$1',$jsString);$jsString=preg_replace('~;+~',';',$jsString);$jsString=preg_replace('~\s+~',' ',$jsString);return $jsString;}private function removeCssComments($cssString=''){$cssString=preg_replace(['/\/\*[\s\S]*?\*\//','/\s*([\{\};:,\>])\s*/','/;}/','/\s+/'],['','$1','}',' '],$cssString);return trim($cssString);}private function removeHtmlComments($htmlString=''){$htmlString=preg_replace('/<!--(.|\s)*?-->/','',$htmlString);$htmlString=preg_replace('/\s+/',' ',$htmlString);$htmlString=preg_replace('/\s*([<>])\s*/','$1',$htmlString);$htmlString=str_replace(['" />'],['"/>'],$htmlString);return $htmlString;}public function minifyOutput($html){if(!empty($html['body'])){$html['body']=$this->removeHtmlComments($html['body']);}if(!empty($html['css'])){$html['css']=$this->removeCssComments($html['css']);}if(!empty($html['head'])){$html['head']=$this->removeHtmlComments($html['head']);}if(!empty($html['js'])){$html['js']=$this->removeJsComments($html['js']);}return $html;}private array $safeHTMLStrings=[];public function safeForHTML($text=''){if(!empty($this->safeHTMLStrings[$text])){return $this->safeHTMLStrings[$text];}$this->safeHTMLStrings[$text]=htmlspecialchars($text,ENT_QUOTES,'UTF-8');return $this->safeHTMLStrings[$text];}private array $safeJSONPStrings=[];public function safeForJSONP($text=''){if(!empty($this->safeJSONPStrings[$text])){return $this->safeJSONPStrings[$text];}$this->safeJSONPStrings[$text]=preg_replace('/[^a-zA-Z0-9_\.-]/','',$text);return $this->safeJSONPStrings[$text];}public function strEndsWith(string $haystack,string $needle){$needle_len=strlen($needle);return ($needle_len===0 || 0===substr_compare($haystack,$needle,-$needle_len));}public function strStartsWith(string $haystack,string $needle){return strncmp($haystack,$needle,strlen($needle))===0;}private $executionTimes=[];public function startExecTime($key){$this->executionTimes[$key]['start']=microtime(true);}public function endExecTime($key){$executionTime=microtime(true) - $this->executionTimes[$key]['start'];$executionTime=round($executionTime,2);unset($this->executionTimes[$key]);return $executionTime;}public function arrayDiff2D($arr1,$arr2){$arr1Assoc=[];foreach($arr1 as $item){if(isset($item['tag']) && isset($item['count'])){$arr1Assoc[$item['tag']]=$item['count'];}} $arr2Assoc=[];foreach($arr2 as $item){if(isset($item['tag']) && isset($item['count'])){$arr2Assoc[$item['tag']]=$item['count'];}} $diff=[];foreach($arr1Assoc as $tag=>$count){if(!isset($arr2Assoc[$tag])){$diff[]=['tag'=>$tag,'count'=>$count,'status'=>'removed'];}elseif($arr2Assoc[$tag] != $count){$diff[]=['tag'=>$tag,'count'=>$count,'status'=>'modified'];}} foreach($arr2Assoc as $tag=>$count){if(!isset($arr1Assoc[$tag])){$diff[]=['tag'=>$tag,'count'=>$count,'status'=>'added'];}} return $diff;}public function urlDecode($url){$placeholder='__PLUS__';$placeholder2='__ENCODED_AMPERSAND__';$urlWithPlaceholder=str_replace('+',$placeholder,$url);$urlWithPlaceholder=str_replace('%26',$placeholder2,$url);$decodedUrl=urldecode($urlWithPlaceholder);$finalUrl=str_replace($placeholder,'+',$decodedUrl);$finalUrl=str_replace($placeholder2,'%26',$decodedUrl);return $finalUrl;}public function setCacheHeaders($days=1){$secondsToCache=$days * 24 * 60 * 60;header('Pragma:cache');header('Cache-Control:max-age='.$secondsToCache,true);}public function fetch($url,$type){$options=array( 'http'=>array( 'user_agent'=>'Mozilla/5.0 (Windows NT 10.0;Win64;x64) AppleWebKit/537.36 (KHTML,like Gecko) Chrome/124.0.0.0 Safari/537.36' ),"ssl"=>array( "verify_peer"=>false,"verify_peer_name"=>false,),);$context=stream_context_create($options);$content=file_get_contents($url,false,$context);foreach($http_response_header as $c=>$h){if(stristr($h,'content-encoding') and stristr($h,'gzip')){$content=gzinflate(substr($content,10,-8));}} switch($type){case 'xml':$content=str_replace(["\0","&nbsp;"],[""," "],$content);$simpleXml=simplexml_load_string($content,"SimpleXMLElement",LIBXML_NOCDATA);return $simpleXml;break;case 'text':default:return $content;break;}} }
class View{private $salad;public string $nonce='';public array $content=['html'=>['css'=>'','js'=>'','title'=>'','head'=>'','body'=>'']];public \stdClass $data;private string $tpl='';public function __construct($salad){$this->salad=$salad;$this->nonce=$this->salad->response->nonce();}public function render($tpl,$data=[]){if(!empty($data)){$this->data=new \stdClass();foreach($data as $dK=>$dV){$this->data->$dK=$dV;}} $this->tpl=$tpl;unset($data);ob_start();include('./themes/'.$this->salad->config->get('ui_theme','ui1').'/'.$this->tpl.'.php');$this->content['html']['body']=ob_get_clean();return $this->content;}public function addCss($file){if(is_file($file)){$file=file_get_contents($file);}$file=str_replace('$___FULL_BASE_URI___$',$this->salad->request->getFullBaseUri(),$file);$this->content['html']['css'] .= $file;}public function addJs($file){if(is_file($file)){$file=file_get_contents($file);}$file=str_replace('$___FULL_BASE_URI___$',$this->salad->request->getFullBaseUri(),$file);$this->content['html']['js'] .= $file;}public function addHtmlTitle($text){$this->content['html']['title']=$text;}public function addHtmlHead($head){if(is_file($head)){$head=file_get_contents($head);}$head=str_replace('$___FULL_BASE_URI___$',$this->salad->request->getFullBaseUri(),$head);$this->content['html']['head']=$head;}}
}
namespace Salad\API\Controllers{
class Home{public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$message=' <h1>Salad API Docs</h1><ul><li>Please refer to old del.icio.us or Pinboard API documentations,as Salad implements (almost) the same functions:</li><li><a rel="noreferrer noopener nofollow" target="_blank" href="https://github.com/pwlin/delicious-api/blob/master/api/posts.md">https://github.com/pwlin/delicious-api/blob/master/api/posts.md</a></li><li><a rel="noreferrer noopener nofollow" target="_blank" href="https://github.com/pwlin/delicious-api/blob/master/api/tags.md">https://github.com/pwlin/delicious-api/blob/master/api/tags.md</a></li><li><a rel="noreferrer noopener nofollow" target="_blank" href="https://pinboard.in/api/">https://pinboard.in/api/</a></li><li>Examples</li> ';foreach(['Tags'=>['Get','Recent','Rename','Delete'],'Posts'=>['Update']] as $catk=>$catv){$message .= '<li>'.$catk.':</li>';foreach($catv as $c){$docExampleFunction='\Salad\API\Controllers\\'.$catk.'\\'.$c.'::getDocExample';if(is_callable($docExampleFunction)){$message .= call_user_func($docExampleFunction,$salad);}}}$message .= ' </ul> ';$css=trim(' body,html{margin:0;padding:0;}h1{margin:0;padding:10px;background-color:#E2E2E2;}');return ['xml'=>'<result><![CDATA['.$message.']]></result>','array'=>['result'=>$message],'html'=>['title'=>'Salad API Home','css'=>$css,'body'=>$message]];}}
class NotFound{public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}http_response_code(404);return $salad->response->generateNotFoundMessage();}}
}
namespace Salad\API\Controllers\Posts{
class Add{public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$args=['url'=>@$args['url'],'description'=>@$args['description'],'extended'=>@$args['extended'],'tags'=>@$args['tags'],'dt'=>@$args['dt'],'replace'=>@$args['replace'],'shared'=>@$args['shared'],'old_hash'=>@$args['old_hash']];if(empty($args['url']) || empty($args['description'])){return $salad->response->generateErrorMessage('for:posts');}$hash=md5($args['url']);$oldHash='';if(!empty($args['old_hash']) && $hash!==$args['old_hash']){$oldHash=$args['old_hash'];}$now=strtotime('now');$created=!empty($args['dt'])?strtotime($args['dt']):$now;$shared=!empty($args['shared']) && in_array($args['shared'],['yes','no'])?$args['shared']:'yes';$tagsWhitelist=$salad->request->getParam('tags_whitelist');if(!empty($tagsWhitelist)){$args['tags'] .= ' '.$tagsWhitelist;}$tags=str_replace(',',' ',$args['tags']);$tags=str_replace('+',' ',$tags);$this_tags='';$this_tags_arr=array_unique(explode(' ',$tags));$filterOutChars=['!','@','#','$','%','^','&','*','(',')','-','_','=','+','{','}','[',']','|','\\',':',';','"','\'','<','>',',','.','?','/','~','`'];$this_tags_arr=array_diff($this_tags_arr,$filterOutChars);foreach($this_tags_arr as $t_t_a){$t_t_a=trim($t_t_a);if(!empty($t_t_a)){$this_tags .= $t_t_a.' ';}} if(!empty($this_tags)){$this_tags=' '.trim($this_tags).' ';}if($oldHash===''){$data=['hash'=>$hash];$sql='SELECT id FROM '.$salad->config->get('db_bookmarks_table_name').' WHERE hash=:hash';$urlAlreadyExists=$salad->db->select($sql,$data);$data=array_merge($data,['url'=>$args['url'],'description'=>$args['description'],'extended'=>$args['extended'],'tags'=>$this_tags,'modified'=>$now,'shared'=>$shared]);$sql='UPDATE '.$salad->config->get('db_bookmarks_table_name').' SET url=:url,description=:description,extended=:extended,tags=:tags,modified=:modified,hash=:hash,shared=:shared WHERE hash=:hash';if(empty($urlAlreadyExists['result'][0])){$data['created']=$created;$sql='INSERT INTO '.$salad->config->get('db_bookmarks_table_name').' (url,description,extended,tags,created,modified,hash,shared) VALUES (:url,:description,:extended,:tags,:created,:modified,:hash,:shared)';}} else{$data=['hash'=>$oldHash];$sql='SELECT id FROM '.$salad->config->get('db_bookmarks_table_name').' WHERE hash=:hash';$urlAlreadyExists=$salad->db->select($sql,$data);if(!empty($urlAlreadyExists['result'][0])){$data=['url'=>$args['url'],'description'=>$args['description'],'extended'=>$args['extended'],'tags'=>$this_tags,'modified'=>$now,'hash'=>$hash,'old_hash'=>$oldHash,'shared'=>$shared];$sql='UPDATE '.$salad->config->get('db_bookmarks_table_name').' SET url=:url,description=:description,extended=:extended,tags=:tags,modified=:modified,hash=:hash,shared=:shared WHERE hash=:old_hash';}else{$data=['url'=>$args['url'],'description'=>$args['description'],'extended'=>$args['extended'],'tags'=>$this_tags,'modified'=>$now,'hash'=>$hash,'created'=>$created,'shared'=>$shared];$sql='INSERT INTO '.$salad->config->get('db_bookmarks_table_name').' (url,description,extended,tags,created,modified,hash,shared) VALUES (:url,:description,:extended,:tags,:created,:modified,:hash,:shared)';}} $addPost=$salad->db->exec($sql,$data);if($addPost['msg']==='ok'){$salad->cache->cleanFolder('tags');$salad->cache->cleanFolder('posts');return $salad->response->generateDoneMessage('for:posts');}else{return $salad->response->generateErrorMessage('for:posts');}} }
class All{public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$args=['tag'=>@$args['tag'],'search'=>@$args['search'],'start'=>@$args['start'],'results'=>@$args['results'],'count_only'=>@$args['count_only'],'url'=>@$args['url']];$cacheKey=$salad->cache->makeCacheKey($args,'posts/all-');$postsArray=$salad->cache->get($cacheKey);if(!$postsArray){$postsArray=\Salad\API\Controllers\Posts\Common::getFresh($salad,$args,'all');$salad->cache->set($cacheKey,$postsArray,-1);}return $postsArray;}}
class AllHashes{public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$args=[];$cacheKey=$salad->cache->makeCacheKey($args,'posts/allHashes-');$postsArray=$salad->cache->get($cacheKey);if(!$postsArray){$postsArray=\Salad\API\Controllers\Posts\Common::getFresh($salad,$args,'allHashes');$salad->cache->set($cacheKey,$postsArray,-1);}return $postsArray;}}
class Common{public static function getFresh($salad,$args=[],$apiCall='get'){$args=['tag'=>@$args['tag'],'search'=>@$args['search'],'dt'=>@$args['dt'],'url'=>@$args['url'],'hashes'=>@$args['hashes'],'meta'=>in_array(@$args['meta'],['yes','no'])?$args['meta']:'no','count'=>ctype_digit(''.@$args['count'])?$args['count']:'100','start'=>ctype_digit(''.@$args['start'])?intval($args['start']):'0','results'=>ctype_digit(''.@$args['results'])?$args['results']:'10000000','count_only'=>in_array(@$args['count_only'],['yes','no'])?$args['count_only']:'no'];if($args['start']<0){$args['start']=0;}$where='';$sqlParams=[];$sqlFields=$apiCall==='allHashes'?' url,modified ':' * ';$sql='SELECT '.$sqlFields.' FROM '.$salad->config->get('db_bookmarks_table_name').' ';list($tags_where,$tags_data,$tags_selected)=$salad->sqlUtils->buildWhereQueryForTags($args['tag']);list($url_where,$url_data)=$salad->sqlUtils->buildWhereQueryForUrl($args['url']);list($hashes_where,$hashes_data)=$salad->sqlUtils->buildWhereQueryForHashes($args['hashes']);list($search_where,$search_data)=$salad->sqlUtils->buildWhereQueryForSearch($args['search']);list($dt_where,$dt_data)=$salad->sqlUtils->buildWhereQueryForDate($args['dt']);if(!empty($tags_where)){$where .= ' '.$tags_where.' AND ';}if(!empty($url_where)){$where .= ' '.$url_where.' AND ';}if(!empty($hashes_where)){$where .= ' '.$hashes_where.' AND ';}if(!empty($search_where)){$where .= ' '.$search_where.' AND ';}if(!empty($dt_where)){$where .= ' '.$dt_where.' AND ';}$where=rtrim($where,' AND ');$sqlParams=array_merge($tags_data,$url_data,$hashes_data,$search_data,$dt_data);$orderBy=' ORDER BY created DESC ';switch($apiCall){case 'recent':if(!empty($where)){$where=' WHERE '.$where.' '.$orderBy;}else{$where=' '.$orderBy;}$where .= ' LIMIT 0,'.intval($args['count']);break;case 'all':case 'allHashes':case 'dates':if(!empty($where)){$where=' WHERE '.$where.' '.$orderBy;}else{$where=' '.$orderBy;}$where .= ' LIMIT '.$args['start'].','.intval($args['results']).' ';break;case 'get':default:$lastBookmarkDateSQL='SELECT MAX(modified) AS modified FROM '.$salad->config->get('db_bookmarks_table_name').' ';if(!empty($where)){$lastBookmarkDateSQL .= ' WHERE '.$where.' '.$orderBy;}else{$lastBookmarkDateSQL .= ' '.$orderBy;}$lastBookmarkDate=$salad->db->select($lastBookmarkDateSQL,$sqlParams);if(!empty($lastBookmarkDate['result'][0]['modified'])){$lastBookmarkDate=$lastBookmarkDate['result'][0]['modified'];$lastBookmarkDateStart=strtotime(gmdate('d.m.Y 00:00:00',$lastBookmarkDate));$lastBookmarkDateEnd=strtotime(gmdate('d.m.Y 23:59:59',$lastBookmarkDate));$and='';if(!empty($where)){$and=' AND ';}$where=' WHERE '.$where.$and.' created BETWEEN "'.$lastBookmarkDateStart.'" AND "'.$lastBookmarkDateEnd.'" '.$orderBy;}else{return ['xml'=>'<posts/>','array'=>[],'sql'=>$sql,'sql_params'=>$sqlParams,'selected_tags'=>$tags_selected];}break;}if($apiCall==='all' && $args['count_only']==='yes'){$sql='SELECT id FROM '.$salad->config->get('db_bookmarks_table_name');$sql .= ' '.$where.' ';$results=$salad->db->select($sql,$sqlParams);$count=count($results['result']);$tags_selected=implode('+',$tags_selected);$xml=new \SimpleXMLElement('<posts/>');$xml->addChild('count',$count);$xml->addChild('selected_tags',$tags_selected);return ['xml'=>$xml->asXML(),'array'=>['count'=>$count,'selected_tags'=>$tags_selected],'sql'=>$sql,'sql_params'=>$sqlParams,'selected_tags'=>$tags_selected];}$sql=$sql.' '.$where;$results=$salad->db->select($sql,$sqlParams);$xml=new \SimpleXMLElement('<posts/>');$array=[];foreach($results['result'] as $res){$meta=md5($res['modified'].$res['url']);$urlHash=md5($res['url']);if($apiCall==='allHashes'){$p=$xml->addChild('post');$p->addAttribute('meta',$meta);$p->addAttribute('url',$urlHash);$array[]=['meta'=>$meta,'url'=>$urlHash];}else{$href=$res['url'];$description=$res['description'];$extended=$res['extended'];$hash=$res['hash'];$tags=trim($res['tags']);$time=gmdate('Y-m-d\TH:i:s\Z',$res['created']);$shared=$res['shared'];$p=$xml->addChild('post');$p->addAttribute('href',$href);$p->addAttribute('description',$description);$p->addAttribute('extended',''.$extended);$p->addAttribute('hash',$hash);$p->addAttribute('meta',$meta);$p->addAttribute('tag',$tags);$p->addAttribute('time',$time);$p->addAttribute('shared',$shared);$array[]=['href'=>$href,'description'=>$description,'extended'=>$extended,'hash'=>$hash,'meta'=>$meta,'tag'=>$tags,'time'=>$time,'shared'=>$shared];}} return ['xml'=>$xml->asXML(),'array'=>$array,'sql'=>$sql,'sql_params'=>$sqlParams,'selected_tags'=>$tags_selected];}}
class Dates{public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$args=['tag'=>@$args['tag']];$cacheKey=$salad->cache->makeCacheKey($args,'posts/dates-');$postsArray=$salad->cache->get($cacheKey);if(!$postsArray){$postsArray=\Salad\API\Controllers\Posts\Common::getFresh($salad,$args,'dates');$sortedArray=self::groupByDates($postsArray['array']);$sortedArray['tag']=implode('+',@$postsArray['selected_tags']);$postsArray['array']=$sortedArray;$xml=new \SimpleXMLElement('<dates/>');$xml->addAttribute('tag',$sortedArray['tag']);foreach($sortedArray['dates'] as $d){$c=$xml->addChild('date');$c->addAttribute('count',$d['count']);$c->addAttribute('date',$d['date']);}$postsArray['xml']=$xml->asXML();$salad->cache->set($cacheKey,$postsArray,-1);}return $postsArray;}private static function groupByDates($array){$newArray=[];foreach($array as $value){$temp=explode("T",$value['time']);$date=$temp[0];$total=(!empty($newArray[$date]['count'])?$newArray[$date]['count'] + (!empty($value['count'])?$value['count']:1):1);$newArray[$date]=array('date'=>$date,'count'=>$total);}$newArray2=['dates'=>[]];foreach($newArray as $k=>$v){$newArray2['dates'][]=$v;}return $newArray2;}}
class Delete{public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$args=['url'=>@$args['url']];if(empty($args['url'])){return $salad->response->generateErrorMessage('for:posts');}$sql='DELETE FROM '.$salad->config->get('db_bookmarks_table_name').' WHERE hash=:hash';$sqlParams=['hash'=>md5($args['url'])];$deletePost=$salad->db->exec($sql,$sqlParams);if($deletePost['msg']==='ok'){$salad->cache->cleanFolder('tags');$salad->cache->cleanFolder('posts');return $salad->response->generateDoneMessage('for:posts');}else{return $salad->response->generateErrorMessage('for:posts');}} }
class FavIcon{private static $salad;public static string $defaultFavicon='iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAK8AAACvABQqw0mAAAABZ0RVh0Q3JlYXRpb24gVGltZQAwNC8yMC8yNKUJNogAAAAhdEVYdFNvZnR3YXJlAE1hY3JvbWVkaWEgRmlyZXdvcmtzIDQuMOomJ3UAAAKjSURBVHicpZNNTxNhFIWfwszQTtuhZfqRIhRbG8QoGkkxRHRhDMa4YAcLF34sWOHPgYU2utQEdpi4YQ0SaDFqTFCxYtES2uK0pWXKTOu4UCZi3HnW9573ufe+x2FZFv8jAcDhcDAxMefaNYqB0WR82DSa01pZT1aqDQ+A4nXW/D5XWuoQZpfS2bWwFCzNz0/qlmXhsCyLycl5V83UuhP94ala/XA8EVND0XiXapgtJLGdWFRlcXFjbyunFRSvtLD5oZjyiP783NyELgDsGsXAhdMnpg705u1z5yO9sT4VtywxNNhD/cCgr1shHg2obzfy6tNnGU8iEeT1x51ZYLsNYDQZH67WGuP37w73xvpUAAyzxcr6F3vWkCojiu3cu3Opt1I/HB9NxocB2gCMw+b0yV5/aORi1G4wzRam2cLfKQNQ15uUKzr+ThfRE/5Qo2FO2wZaWU+OjQ2odb15bMPXr/SjuAUA3C6B06dCZHPfuXnzjKppetK+QqWqe8IBBcUt4JYleiI+eiI+uxmgvQ12S/sAhAMK1arusQkA3LIEwMjQSb7ulDHM4zRHEsV2AI5+j3B052yupESCURS3wI2rCZYyOd7/LopHA0SCMtdGYpTKDd5/KqB4nTWboMsvpxcXN/b+fGlwoJtCqUahVGNlfYvVN3kAAj4nz5+/2+vyyWnbQBSFma2cVljK5P6JDfBtp0zrByxlcuR3K4UOpzhjGyyvZ9OKV1pIPXm5fWSiuAUGB7qPEa28yvEwtbzt83QsLK9n0/YOwlKwtPmhmEr0B3n0eHn8xYt3oVu3zqqm2UKrHGAYLdKrK3vb+XLB5+1Y2NwspsJSsAT8ysKfYbo8FE8eGuYDTdOT1f2Gx7IsFK+zpnbJa7JTmFlNf850/h2m/9FP01chchV8TiUAAAAASUVORK5CYII=';public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$args=['hash'=>@$args['hash'],'url'=>@$args['url'],'api_key'=>@$args['api_key'],'skip_url_check'=>@$args['skip_url_check']];if(empty($args['hash']) && !empty($args['url'])){$args['hash']=md5($args['url']);}if($salad->config->get('fetch_favicons')!==true || empty($args['hash'])){return ['bin-data'=>base64_decode(self::$defaultFavicon)];}self::$salad=$salad;$hashCacheKey=self::$salad->cache->makeCacheKey($args['hash'],'favicons/hash-');$hashObj=self::$salad->cache->get($hashCacheKey);if(!empty($hashObj)){return ['bin-data'=>base64_decode($hashObj)];}else{if($args['skip_url_check']!==true){$bookmark=\Salad\API\Controllers\Posts\Get::index( self::$salad,['hashes'=>$args['hash'],'skip_auth'=>true] );if(empty($bookmark['array'])){return ['bin-data'=>base64_decode(self::$defaultFavicon)];}$url=$bookmark['array'][0]['href'];}else{$url=$args['url'];}$data='';$favIconServerUrl='https://t1.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&size=128&url=';if(empty($url) || !self::$salad->utils->isValidUrl($url)){self::$salad->cache->set($hashCacheKey,self::$defaultFavicon,-1);return ['bin-data'=>base64_decode(self::$defaultFavicon)];}else{$data=$salad->utils->fetch($favIconServerUrl.urlencode($url),'text');if(empty($data)){$data=self::$defaultFavicon;}else{$data=base64_encode($data);}self::$salad->cache->set($hashCacheKey,$data,-1);return ['bin-data'=>base64_decode($data)];}}}}
class Get{public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$args=['tag'=>@$args['tag'],'search'=>@$args['search'],'dt'=>@$args['dt'],'url'=>@$args['url'],'hashes'=>@$args['hashes']];$cacheKey=$salad->cache->makeCacheKey($args,'posts/get-');$postsArray=$salad->cache->get($cacheKey);if(!$postsArray){$postsArray=\Salad\API\Controllers\Posts\Common::getFresh($salad,$args,'get');$salad->cache->set($cacheKey,$postsArray,-1);}return $postsArray;}}
class Recent{public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$args=['tag'=>@$args['tag'],'count'=>@$args['count'],'search'=>@$args['search']];$cacheKey=$salad->cache->makeCacheKey($args,'posts/recent-');$postsArray=$salad->cache->get($cacheKey);if(!$postsArray){$postsArray=\Salad\API\Controllers\Posts\Common::getFresh($salad,$args,'recent');$salad->cache->set($cacheKey,$postsArray,-1);}return $postsArray;}}
class Suggest{private static $salad;public static function index($salad,$args=[]){self::$salad=$salad;if(!self::$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>9,'skip_auth'=>@$args['skip_auth']])){return self::$salad->response->generateAuthFailedMessage();}$args=['url'=>@$args['url']];if( self::$salad->config->get('fetch_popular_tags')!==true || empty($args['url']) || !preg_match('/^http/',$args['url']) || preg_match('/\/\/localhost|\/\/192\.168\.|\/\/127\.0\.|\/\/10\.0\./',$args['url']) ){return ['xml'=>'<suggest/>','array'=>[],'sql'=>$args['url'],];}$cacheKey=self::$salad->cache->makeCacheKey($args,'suggestions/url-');$popularTags=self::$salad->cache->get($cacheKey);if(!$popularTags){$popularTags=self::tagsSuggestionsFromPinboard($args['url']);$popularTags=self::cleanSuggestedTags($popularTags);self::$salad->cache->set($cacheKey,$popularTags,-1);}$array=[];$xml='<suggest/>';if(self::$salad->request->getParam('format')==='xml'){$xml=new \SimpleXMLElement('<suggest/>');}foreach($popularTags as $pop){if(self::$salad->request->getParam('format')==='xml'){$xml->addChild('popular',$pop);}$array[]['tag']=$pop;}if(self::$salad->request->getParam('format')==='xml'){$xml=$xml->asXML();}return ['xml'=>$xml,'array'=>$array,'sql'=>$args['url']];}private static function tagsSuggestionsFromPinboard($url){$pinboardTags=[];$pinboardUrl='http://pinboard.in/url/';$postFields=['url'=>$url];$ch=curl_init();curl_setopt($ch,CURLOPT_HEADER,false);curl_setopt($ch,CURLOPT_FOLLOWLOCATION,true);curl_setopt($ch,CURLOPT_URL,$pinboardUrl);curl_setopt($ch,CURLOPT_POST,count($postFields));curl_setopt($ch,CURLOPT_POSTFIELDS,$postFields);curl_setopt($ch,CURLOPT_RETURNTRANSFER,true);curl_setopt($ch,CURLOPT_HTTPHEADER,['Connection:close','Accept-Language:en-us,en;q=0.5']);$result=curl_exec($ch);curl_close($ch);libxml_use_internal_errors(true);$dom=new \DOMDocument('1.0','UTF-8');$dom->strictErrorChecking=false;$dom->validateOnParse=false;$dom->recover=true;if($result){$dom->loadHTML($result);$xpath=new \DOMXPath($dom);$allAnchors=$xpath->evaluate('//html//body//a[@class="tag"]');for ($i=0,$k=$allAnchors->length;$i<$k;$i++){$element=$allAnchors->item($i);$nodeValue=$element->nodeValue;$nodeValue=preg_split('/[\s,_]+/',$nodeValue);foreach($nodeValue as $n_v){$n_v=trim($n_v);if(!empty($n_v)){$pinboardTags[]=$n_v;}}}unset($xpath);}unset($dom);libxml_clear_errors();libxml_use_internal_errors(false);return $pinboardTags;}private static function cleanSuggestedTags($tags){$tags=array_unique($tags);$tagsTmp=[];$blacklistFull=['+','-','|','&amp;','&'];$blacklistPartial=['+','&amp;','&',];foreach($tags as $tag){$blacklistPartialFound=false;$tag=trim($tag);if(!empty($tag)){if(in_array($tag,$blacklistFull)){continue;}else{foreach($blacklistPartial as $blp){if(stripos($tag,$blp)!==false){$blacklistPartialFound=true;break;}} if($blacklistPartialFound===false){$tagsTmp[]=$tag;}}}} usort($tagsTmp,'strnatcasecmp');return $tagsTmp;}}
class Update{public static function getDocExample($salad){return '<li><a target="_blank" rel="noreferrer noopener nofollow" href="'.$salad->request->getParam('base_uri').'posts/update">/posts/update</a></li>';}public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$sql='SELECT MAX(modified) AS modified,COUNT(id) AS count FROM '.$salad->config->get('db_bookmarks_table_name').' ';$update=$salad->db->select($sql);$lastModified=gmdate('Y-m-d\TH:i:s\Z',strtotime('now'));if(!empty($update['result'][0]['modified'])){$lastModified=gmdate('Y-m-d\TH:i:s\Z',$update['result'][0]['modified']);}$count=$update['result'][0]['count'];$xml=new \SimpleXMLElement('<update/>');$xml->addAttribute('code','200');$xml->addAttribute('message','success');$xml->addAttribute('time',$lastModified);$xml->addAttribute('count',$count);$array=['code'=>'200','message'=>'success','time'=>$lastModified,'count'=>$count];return ['sql'=>$sql,'sql_params'=>[],'xml'=>$xml->asXML(),'array'=>$array];}}
}
namespace Salad\API\Controllers\Tags{
class Common{private static $salad;public static function getFresh($salad,$args=[],$apiCall='get'){self::$salad=$salad;$args=['tag'=>@$args['tag'],'search'=>@$args['search'],'sort'=>@$args['sort']];$query='';$where='';$sqlParams=[];$tags_where='';$search_where='';switch($apiCall){case 'recent':$tags_selected=[];break;case 'get':default:list($tags_where,$tags_data,$tags_selected)=self::$salad->sqlUtils->buildWhereQueryForTags($args['tag']);list($search_where,$search_data)=self::$salad->sqlUtils->buildWhereQueryForSearch($args['search']);break;}if(!empty($tags_where) || !empty($search_where)){switch(self::$salad->config->get('db_type')){case 'mysql':$where .= ' AND ';break;case 'sqlite':$where .= " WHERE :selected_tags='' OR ";break;}if(!empty($tags_where)){$where .= ' '.$tags_where.' AND ';}if(!empty($search_where)){$where .= ' '.$search_where.' AND ';}$where=rtrim($where,' AND ');$sqlParams=array_merge($tags_data,$search_data);}$query=self::sql($where,$apiCall);$results=self::$salad->db->select($query,$sqlParams);if(empty($results['result'])){return ['xml'=>'<tags/>','array'=>[],'sql'=>$query,'sql_params'=>$sqlParams,'selected_tags'=>$tags_selected];}$uniqTags=$results['result'];self::assignCssClasses($uniqTags,$args['tag']);$xml='<tags/>';if(self::$salad->request->getParam('format')==='xml'){$xml=new \SimpleXMLElement($xml);foreach($uniqTags as $tag){$t=$xml->addChild('tag');$t->addAttribute('count',$tag['count']);$t->addAttribute('tag',$tag['tag']);}$xml=$xml->asXML();}return ['xml'=>$xml,'array'=>$uniqTags,'sql'=>$query,'sql_params'=>$sqlParams,'selected_tags'=>$tags_selected];}private static function buildLinkForPlus($thisTag,$existingTags=''){$link=self::$salad->request->getFullBaseUri();$urlTag=!empty($existingTags)?$existingTags:'';$urlTag=$urlTag.'+'.$thisTag;$urlTag=trim($urlTag,'+');if(!empty($urlTag)){$urlTag='tag/'.self::$salad->utils->safeForHTML($urlTag);}return $link.$urlTag;}public static function buildLinkForMinus($salad,$thisTag,$existingTags=''){$link=$salad->request->getFullBaseUri();$urlTag=!empty($existingTags)?$existingTags:'';$urlTag=str_replace($thisTag,'',$urlTag);$urlTag=trim($urlTag,'+');$urlTag=preg_replace('/\+{2,}/','+',$urlTag);if(!empty($urlTag)){$urlTag='tag/'.$salad->utils->safeForHTML($urlTag);}return $link.$urlTag;}private static function mySqlQueryCreateTemp(){$sql="CREATE TEMPORARY TABLE numbers (n INT);INSERT INTO numbers (n) VALUES (1),(2),(3),(4),(5),(6),(7),(8),(9),(10);SELECT tag,COUNT(*) AS count FROM ( SELECT TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(b.tags,' ',numbers.n),' ',-1)) AS tag FROM numbers INNER JOIN ".self::$salad->config->get('db_bookmarks_table_name')." b ON CHAR_LENGTH(b.tags) - CHAR_LENGTH(REPLACE(b.tags,' ','')) >= numbers.n - 1 WHERE TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(b.tags,' ',numbers.n),' ',-1)) <> '' ) AS tags GROUP BY tag ORDER BY tag ASC;DROP TEMPORARY TABLE numbers;";return $sql;}private static function sql($where,$apiCall=''){switch(self::$salad->config->get('db_type')){case 'mysql':return self::mySqlQuerySelect($where,$apiCall);break;case 'sqlite':return self::sqliteQuerySelect($where,$apiCall);break;}} private static function sqliteQuerySelect($where='',$apiCall=''){$createdTXT=$apiCall==='recent'?',created':'';$sql="WITH RECURSIVE split_tags(bookmark_id,tag,rest ".$createdTXT.") AS ( SELECT id,TRIM(SUBSTR(tags,1,INSTR(tags || ' ',' ') - 1)),LTRIM(SUBSTR(tags,INSTR(tags || ' ',' '))) ".$createdTXT." FROM ".self::$salad->config->get('db_bookmarks_table_name')." UNION ALL SELECT bookmark_id,TRIM(SUBSTR(rest,1,INSTR(rest || ' ',' ') - 1)),LTRIM(SUBSTR(rest,INSTR(rest || ' ',' '))) ".$createdTXT." FROM split_tags WHERE rest <> '' ),selected_bookmarks AS ( SELECT id FROM ".self::$salad->config->get('db_bookmarks_table_name')." ";$sql .= " ".$where." ";$sql .= ") SELECT tag AS tag,COUNT(*) AS count";if($apiCall==='recent'){$sql .= ',MAX(created) AS last_added ';}$sql .= " FROM split_tags WHERE tag <> '' AND bookmark_id IN (SELECT id FROM selected_bookmarks) GROUP BY tag";if($apiCall==='recent'){$sql .= ' ORDER BY last_added DESC LIMIT 0,80';}else{switch(self::$salad->config->get('db_type')){case 'mysql':$sql .= ' ORDER BY tag ASC';break;case 'sqlite':$sql .= ' ORDER BY tag COLLATE NOCASE ASC';break;}} return $sql;}private static function mySqlQuerySelect9(){$sql="WITH split_tags AS ( SELECT id AS bookmark_id,TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(tags,' ',numbers.n),' ',-1)) AS tag,created FROM bookmarks JOIN ( SELECT 1 AS n UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10 ) numbers ON CHAR_LENGTH(tags) - CHAR_LENGTH(REPLACE(tags,' ','')) >= numbers.n - 1 ),selected_bookmarks AS ( SELECT id FROM bookmarks <!-- extra WHERE --> ) SELECT tag AS tag,COUNT(*) AS count,MAX(created) AS last_added FROM split_tags WHERE tag <> '' AND bookmark_id IN (SELECT id FROM selected_bookmarks) GROUP BY tag ORDER BY tag ASC;";return $sql;}private static function mySqlQuerySelect($where='',$apiCall=''){$sql="SELECT tag,COUNT(*) AS count";if($apiCall==='recent'){$sql .= ',MAX(created) AS last_added ';}$sql .= " FROM ( SELECT TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(b.tags,' ',numbers.n),' ',-1)) AS tag,b.created FROM (SELECT 1 n UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5 UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9 UNION SELECT 10) numbers INNER JOIN ".self::$salad->config->get('db_bookmarks_table_name')." b ON CHAR_LENGTH(b.tags) - CHAR_LENGTH(REPLACE(b.tags,' ','')) >= numbers.n - 1 WHERE TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(b.tags,' ',numbers.n),' ',-1)) <> '' ";$sql .= " ".$where." ";$sql .= " ) AS tags GROUP BY tag";if($apiCall==='recent'){$sql .= ' ORDER BY last_added DESC LIMIT 0,80';}else{switch(self::$salad->config->get('db_type')){case 'mysql':$sql .= ' ORDER BY tag ASC';break;case 'sqlite':$sql .= ' ORDER BY tag COLLATE NOCASE ASC';break;}} return $sql;}private static function assignCssClasses(&$uniqTags,$tag){$cssClasses=['text1','text2','text3','text4','text5'];$numTags=count($uniqTags);if($numTags == 0){return $uniqTags;}$counts=array_column($uniqTags,'count');sort($counts);$percentiles=[];for ($i=1;$i <= 4;$i++){$percentiles[]=$counts[ceil($i * $numTags / 5) - 1];}foreach($uniqTags as &$t){$t['link']=self::buildLinkForPlus($t['tag'],$tag);if($t['count'] <= $percentiles[0]){$t['css_class']=$cssClasses[0];}elseif($t['count'] <= $percentiles[1]){$t['css_class']=$cssClasses[1];}elseif($t['count'] <= $percentiles[2]){$t['css_class']=$cssClasses[2];}elseif($t['count'] <= $percentiles[3]){$t['css_class']=$cssClasses[3];}else{$t['css_class']=$cssClasses[4];}}}}
class Delete{public static function getDocExample($salad){return '<li>tags/delete</li><li><a target="_blank" rel="noreferrer noopener nofollow" href="'.$salad->request->getParam('base_uri').'tags/delete?tag=php">/tags/delete?tag=php</a></li>';}public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$args=['tag'=>@$args['tag'],'also_delete_bookmarks'=>@$args['also_delete_bookmarks']];if(empty($args['tag'])){return $salad->response->generateErrorMessage('for:tags');}$sql='SELECT hash,tags FROM '.$salad->config->get('db_bookmarks_table_name').' WHERE tags LIKE :tag ';$sqlParams=['tag'=>'% '.$args['tag'].' %'];$posts=$salad->db->select($sql,$sqlParams);if(empty($posts['result'])){return $salad->response->generateDoneMessage('for:tags');}$posts=$posts['result'];foreach($posts as $p){$tags_tmp=[];$tags_p=explode(' ',$p['tags']);foreach($tags_p as $tag_p){$tag_p=trim($tag_p);if(empty($tag_p)){continue;}if($tag_p===$args['tag']){continue;}$tags_tmp[]=$tag_p;}$tags_tmp=trim(implode(' ',$tags_tmp));$tags_tmp=' '.$tags_tmp.' ';$data[]=['hash'=>$p['hash'],'tags'=>$tags_tmp,];}$queries=[];foreach($data as $d){if($args['also_delete_bookmarks']==='yes'){$queries[]=['sql'=>'DELETE FROM '.$salad->config->get('db_bookmarks_table_name').' WHERE hash=:hash','params'=>['hash'=>$d['hash']]];}else{$queries[]=['sql'=>'UPDATE '.$salad->config->get('db_bookmarks_table_name').' SET tags=:tags WHERE hash=:hash','params'=>$d];}} $salad->db->exec($queries);$salad->cache->cleanFolder('tags');$salad->cache->cleanFolder('posts');return $salad->response->generateDoneMessage('for:tags');}}
class Get{public static function getDocExample($salad){return '<li>/tags/get</li><li><a target="_blank" rel="noreferrer noopener nofollow" href="'.$salad->request->getParam('base_uri').'tags/get?tag=html5">/tags/get?tag=html5</a></li><li><a target="_blank" rel="noreferrer noopener nofollow" href="'.$salad->request->getParam('base_uri').'tags/get?sort=freq">/tags/get?sort=freq</a></li><li><a target="_blank" rel="noreferrer noopener nofollow" href="'.$salad->request->getParam('base_uri').'tags/get?sort=alpha&format=json">/tags/get?sort=alpha&format=json</a></li> ';}public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$args=['tag'=>@$args['tag'],'search'=>@$args['search'],'sort'=>@$args['sort']];$cacheKey=$salad->cache->makeCacheKey($args,'tags/tags-');$tagsArray=$salad->cache->get($cacheKey);if(!$tagsArray){$tagsArray=\Salad\API\Controllers\Tags\Common::getFresh($salad,$args,'get');if(count($tagsArray['array'])>0){$salad->cache->set($cacheKey,$tagsArray,-1);}} return $tagsArray;}}
class Recent{public static function getDocExample($salad){return '<li>/tags/recent</li><li><a target="_blank" rel="noreferrer noopener nofollow" href="'.$salad->request->getParam('base_uri').'tags/recent">/tags/recent</a></li> ';}public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$tagsArray=\Salad\API\Controllers\Tags\Common::getFresh($salad,[],'recent');return $tagsArray;}}
class Rename{public static function getDocExample($salad){return '<li>tags/rename</li><li><a target="_blank" rel="noreferrer noopener nofollow" href="'.$salad->request->getParam('base_uri').'tags/rename?old=php&new=php1">/tags/rename?old=php&new=php1</a></li>';}public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$args=['old'=>@$args['old'],'new'=>@$args['new'],];if(empty($args['old']) || empty($args['new'])){return $salad->response->generateErrorMessage('for:tags');}$sql='SELECT hash,tags FROM '.$salad->config->get('db_bookmarks_table_name').' WHERE tags LIKE :old ';$sqlParams=['old'=>'% '.$args['old'].' %'];$posts=$salad->db->select($sql,$sqlParams);if(empty($posts['result'])){return $salad->response->generateDoneMessage('for:tags');}$posts=$posts['result'];$data=[];foreach($posts as $p){$tags_tmp=[];$tags_p=explode(' ',$p['tags']);foreach($tags_p as $tag_p){$tag_p=trim($tag_p);if(empty($tag_p)){continue;}if($tag_p===$args['new']){continue;}if($tag_p===$args['old']){$tags_tmp[]=$args['new'];}else{$tags_tmp[]=$tag_p;}} $tags_tmp=trim(implode(' ',$tags_tmp));$tags_tmp=' '.$tags_tmp.' ';$data[]=['hash'=>$p['hash'],'tags'=>$tags_tmp];}$queries=[];foreach($data as $d){$queries[]=['sql'=>'UPDATE '.$salad->config->get('db_bookmarks_table_name').' SET tags=:tags WHERE hash=:hash','params'=>$d];}$salad->db->exec($queries);$salad->cache->cleanFolder('tags');$salad->cache->cleanFolder('posts');return $salad->response->generateDoneMessage('for:tags');}}
}
namespace Salad\API\Controllers\Keys{
class Add{public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$args=['key1'=>@$args['key1'],'description'=>@$args['description'],'access_level'=>!empty($args['access_level'])?$args['access_level']:'1','enabled'=>!empty($args['enabled']) && in_array($args['enabled'],['yes','no'])?$args['enabled']:'yes','tags_whitelist'=>@$args['tags_whitelist'],];if(empty($args['key1'])){return $salad->response->generateErrorMessage('for:posts','no key1 provided');}if($args['key1']==='gen'){$args['key1']=\Salad\API\Controllers\Keys\Gen::gen();}else{$sql='SELECT id FROM '.$salad->config->get('db_api_keys_table_name').' WHERE key1=:key1';$keyAlreadyExists=$salad->db->select($sql,['key1'=>$args['key1']]);if(!empty($keyAlreadyExists['result'])){return $salad->response->generateErrorMessage('for:posts','key1 already exists. use update');}} $sql='INSERT INTO '.$salad->config->get('db_api_keys_table_name').' (key1,description,access_level,enabled,tags_whitelist) VALUES (:key1,:description,:access_level,:enabled,:tags_whitelist)';$addKey=$salad->db->exec($sql,$args);if($addKey['msg']==='ok'){return $salad->response->generateDoneMessage('for:posts','added '.$args['key1']);}else{return $salad->response->generateErrorMessage('for:posts');}} }
class All{public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$apiKeys=$salad->db->select('SELECT * FROM '.$salad->config->get('db_api_keys_table_name'));$xml=new \SimpleXMLElement('<api_keys/>');foreach($apiKeys['result'] as $v){$xmlKey=$xml->addChild('key');$xmlKey->addAttribute('id',$v['id']);$xmlKey->addAttribute('key1',$v['key1']);$xmlKey->addAttribute('description',$v['description']);$xmlKey->addAttribute('access_level',$v['access_level']);$xmlKey->addAttribute('enabled',$v['enabled']);$xmlKey->addAttribute('tags_whitelist',$v['tags_whitelist']);}return ['xml'=>$xml->asXML(),'array'=>['api_keys'=>$apiKeys['result']]];}}
class Delete{public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$args=['id'=>@$args['id'],];if(empty($args['id'])){return $salad->response->generateErrorMessage('for:posts','no id provided');}$sql='SELECT id FROM '.$salad->config->get('db_api_keys_table_name').' WHERE id=:id';$keyAlreadyExists=$salad->db->select($sql,['id'=>$args['id']]);if(empty($keyAlreadyExists['result'])){return $salad->response->generateErrorMessage('for:posts','id does not exist');}$sql='DELETE FROM '.$salad->config->get('db_api_keys_table_name').' WHERE id=:id';$deleteKey=$salad->db->exec($sql,['id'=>$args['id']]);if($deleteKey['msg']==='ok'){return $salad->response->generateDoneMessage('for:posts','deleted id '.$args['id']);}else{return $salad->response->generateErrorMessage('for:posts');}} }
class Gen{public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$key=self::gen();return ['xml'=>'<key>'.$key.'</key>','array'=>['key'=>$key]];}public static function gen($length=32){return bin2hex(random_bytes($length));}}
class Update{public static function index($salad,$args=[]){if(!$salad->auth->login(['api_key'=>@$args['api_key'],'access_level_needed'=>@$args['access_level_needed'],'skip_auth'=>@$args['skip_auth']])){return $salad->response->generateAuthFailedMessage();}$args=['id'=>@$args['id'],'key1'=>@$args['key1'],'description'=>@$args['description'],'access_level'=>!empty($args['access_level'])?$args['access_level']:'1','enabled'=>!empty($args['enabled']) && in_array($args['enabled'],['yes','no'])?$args['enabled']:'yes','tags_whitelist'=>@$args['tags_whitelist'],];if(empty($args['id'])){return $salad->response->generateErrorMessage('for:posts','no id provided');}$sql='SELECT id FROM '.$salad->config->get('db_api_keys_table_name').' WHERE id=:id';$keyAlreadyExists=$salad->db->select($sql,['id'=>$args['id']]);if(empty($keyAlreadyExists['result'])){return $salad->response->generateErrorMessage('for:posts','id does not exist');}$sql='UPDATE '.$salad->config->get('db_api_keys_table_name').' SET key1=:key1,description=:description,access_level=:access_level,enabled=:enabled,tags_whitelist=:tags_whitelist WHERE id=:id';$updateKey=$salad->db->exec($sql,$args);if($updateKey['msg']==='ok'){return $salad->response->generateDoneMessage('for:posts','updated id '.$args['id']);}else{return $salad->response->generateErrorMessage('for:posts');}} }
}
namespace{
function init(){global $salad_api_file_included;if(@$salad_api_file_included!==true){$salad=new \Salad\Main();if($salad->config->get('enable_web_api')===true || PHP_SAPI==='cli'){$salad->request->handle();echo ($salad->response->getOutput(true));unset($salad);}else{unset($salad);}}}
init();
}
